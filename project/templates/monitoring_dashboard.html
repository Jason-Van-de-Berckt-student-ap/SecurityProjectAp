{% extends "base.html" %} {% block title %}System Monitoring Dashboard - EASM{%
endblock %} {% block content %}
<div
  class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50 dark:from-gray-900 dark:via-gray-800 dark:to-purple-900"
>
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 dark:text-white mb-2">
        System Monitoring Dashboard
      </h1>
      <p class="text-lg text-gray-600 dark:text-gray-300">
        Real-time performance metrics and system status
      </p>
    </div>

    <!-- Refresh Controls -->
    <div class="flex justify-between items-center mb-6">
      <div class="flex space-x-4">
        <button
          id="refreshBtn"
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"
        >
          <i class="fas fa-sync-alt mr-2"></i>Refresh
        </button>
        <select
          id="refreshInterval"
          class="border border-gray-300 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white"
        >
          <option value="0">Manual</option>
          <option value="5000">5 seconds</option>
          <option value="10000" selected>10 seconds</option>
          <option value="30000">30 seconds</option>
        </select>
      </div>
      <div class="text-sm text-gray-500 dark:text-gray-400">
        Last updated: <span id="lastUpdate">Never</span>
      </div>
    </div>

    <!-- System Overview Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- System Status -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">
              System Status
            </p>
            <p id="systemStatus" class="text-2xl font-bold text-green-600">
              Healthy
            </p>
          </div>
          <div class="p-3 bg-green-100 dark:bg-green-900 rounded-full">
            <i class="fas fa-heartbeat text-green-600 text-xl"></i>
          </div>
        </div>
      </div>

      <!-- Active Tasks -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">
              Active Tasks
            </p>
            <p id="activeTasks" class="text-2xl font-bold text-blue-600">0</p>
          </div>
          <div class="p-3 bg-blue-100 dark:bg-blue-900 rounded-full">
            <i class="fas fa-tasks text-blue-600 text-xl"></i>
          </div>
        </div>
      </div>

      <!-- Cache Hit Rate -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">
              Cache Hit Rate
            </p>
            <p id="cacheHitRate" class="text-2xl font-bold text-purple-600">
              --
            </p>
          </div>
          <div class="p-3 bg-purple-100 dark:bg-purple-900 rounded-full">
            <i class="fas fa-database text-purple-600 text-xl"></i>
          </div>
        </div>
      </div>

      <!-- Avg Response Time -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">
              Avg Response
            </p>
            <p id="avgResponseTime" class="text-2xl font-bold text-orange-600">
              --
            </p>
          </div>
          <div class="p-3 bg-orange-100 dark:bg-orange-900 rounded-full">
            <i class="fas fa-tachometer-alt text-orange-600 text-xl"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Performance Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- CPU & Memory Usage -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
          <i class="fas fa-microchip mr-2"></i>System Resources
        </h3>
        <div class="space-y-4">
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-gray-600 dark:text-gray-400">CPU Usage</span>
              <span id="cpuUsage" class="font-medium">--</span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
              <div
                id="cpuBar"
                class="bg-blue-600 h-2 rounded-full transition-all duration-500"
                style="width: 0%"
              ></div>
            </div>
          </div>
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-gray-600 dark:text-gray-400">Memory Usage</span>
              <span id="memoryUsage" class="font-medium">--</span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
              <div
                id="memoryBar"
                class="bg-green-600 h-2 rounded-full transition-all duration-500"
                style="width: 0%"
              ></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Scans -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
          <i class="fas fa-search mr-2"></i>Recent Scan Activity
        </h3>
        <div id="recentScans" class="space-y-2">
          <div class="text-center text-gray-500 dark:text-gray-400 py-4">
            Loading recent scans...
          </div>
        </div>
      </div>
    </div>

    <!-- Active Tasks Table -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
        <i class="fas fa-list mr-2"></i>Active Background Tasks
      </h3>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
              >
                Task ID
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
              >
                Type
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
              >
                Status
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
              >
                Progress
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
              >
                Started
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
              >
                Actions
              </th>
            </tr>
          </thead>
          <tbody
            id="tasksTableBody"
            class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"
          >
            <tr>
              <td
                colspan="6"
                class="px-6 py-4 text-center text-gray-500 dark:text-gray-400"
              >
                No active tasks
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- System Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Database Stats -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
          <i class="fas fa-database mr-2"></i>Database Statistics
        </h3>
        <div class="space-y-3">
          <div class="flex justify-between">
            <span class="text-gray-600 dark:text-gray-400">Total Domains</span>
            <span id="totalDomains" class="font-medium">--</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600 dark:text-gray-400">Total Scans</span>
            <span id="totalScans" class="font-medium">--</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600 dark:text-gray-400">DB Size</span>
            <span id="dbSize" class="font-medium">--</span>
          </div>
        </div>
      </div>

      <!-- Cache Statistics -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
          <i class="fas fa-memory mr-2"></i>Cache Statistics
        </h3>
        <div class="space-y-3">
          <div class="flex justify-between">
            <span class="text-gray-600 dark:text-gray-400">Cache Hits</span>
            <span id="cacheHits" class="font-medium">--</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600 dark:text-gray-400">Cache Misses</span>
            <span id="cacheMisses" class="font-medium">--</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600 dark:text-gray-400">Memory Used</span>
            <span id="cacheMemory" class="font-medium">--</span>
          </div>
        </div>
      </div>

      <!-- Rate Limiting -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
          <i class="fas fa-shield-alt mr-2"></i>Rate Limiting
        </h3>
        <div class="space-y-3">
          <div class="flex justify-between">
            <span class="text-gray-600 dark:text-gray-400">Requests/Min</span>
            <span id="requestsPerMin" class="font-medium">--</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600 dark:text-gray-400">Rate Limited</span>
            <span id="rateLimited" class="font-medium text-red-600">--</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600 dark:text-gray-400">Circuit Status</span>
            <span id="circuitStatus" class="font-medium">--</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript for Dashboard Functionality -->
<script>
  let refreshInterval = null;
  let lastUpdateTime = null;

  // Initialize dashboard
  document.addEventListener("DOMContentLoaded", function () {
    refreshDashboard();
    setupAutoRefresh();
    setupEventListeners();
  });

  function setupEventListeners() {
    document
      .getElementById("refreshBtn")
      .addEventListener("click", refreshDashboard);

    document
      .getElementById("refreshInterval")
      .addEventListener("change", function () {
        setupAutoRefresh();
      });
  }

  function setupAutoRefresh() {
    if (refreshInterval) {
      clearInterval(refreshInterval);
    }

    const interval = parseInt(document.getElementById("refreshInterval").value);
    if (interval > 0) {
      refreshInterval = setInterval(refreshDashboard, interval);
    }
  }

  async function refreshDashboard() {
    try {
      const response = await fetch("/api/system/stats");
      const data = await response.json();

      if (data.success) {
        updateDashboard(data.data);
        lastUpdateTime = new Date();
        document.getElementById("lastUpdate").textContent =
          lastUpdateTime.toLocaleTimeString();
      }
    } catch (error) {
      console.error("Error refreshing dashboard:", error);
      document.getElementById("systemStatus").textContent = "Error";
      document.getElementById("systemStatus").className =
        "text-2xl font-bold text-red-600";
    }
  }

  function updateDashboard(data) {
    // System status
    const status = data.system?.healthy ? "Healthy" : "Degraded";
    const statusColor = data.system?.healthy
      ? "text-green-600"
      : "text-red-600";
    document.getElementById("systemStatus").textContent = status;
    document.getElementById(
      "systemStatus"
    ).className = `text-2xl font-bold ${statusColor}`;

    // Active tasks
    document.getElementById("activeTasks").textContent =
      data.tasks?.active || 0;

    // Cache hit rate
    if (data.cache?.hit_rate !== undefined) {
      document.getElementById("cacheHitRate").textContent = `${(
        data.cache.hit_rate * 100
      ).toFixed(1)}%`;
    }

    // Average response time
    if (data.performance?.avg_response_time !== undefined) {
      document.getElementById(
        "avgResponseTime"
      ).textContent = `${data.performance.avg_response_time.toFixed(0)}ms`;
    }

    // System resources
    if (data.system?.cpu_percent !== undefined) {
      const cpuPercent = data.system.cpu_percent;
      document.getElementById("cpuUsage").textContent = `${cpuPercent.toFixed(
        1
      )}%`;
      document.getElementById("cpuBar").style.width = `${cpuPercent}%`;
    }

    if (data.system?.memory_percent !== undefined) {
      const memoryPercent = data.system.memory_percent;
      document.getElementById(
        "memoryUsage"
      ).textContent = `${memoryPercent.toFixed(1)}%`;
      document.getElementById("memoryBar").style.width = `${memoryPercent}%`;
    }

    // Database statistics
    if (data.database) {
      document.getElementById("totalDomains").textContent =
        data.database.total_domains || "--";
      document.getElementById("totalScans").textContent =
        data.database.total_scans || "--";
      document.getElementById("dbSize").textContent = formatBytes(
        data.database.size_bytes || 0
      );
    }

    // Cache statistics
    if (data.cache) {
      document.getElementById("cacheHits").textContent =
        data.cache.hits || "--";
      document.getElementById("cacheMisses").textContent =
        data.cache.misses || "--";
      document.getElementById("cacheMemory").textContent = formatBytes(
        data.cache.memory_used || 0
      );
    }

    // Rate limiting
    if (data.rate_limiting) {
      document.getElementById("requestsPerMin").textContent =
        data.rate_limiting.requests_per_minute || "--";
      document.getElementById("rateLimited").textContent =
        data.rate_limiting.rate_limited_count || "--";
      document.getElementById("circuitStatus").textContent =
        data.rate_limiting.circuit_status || "--";
    }

    // Recent scans
    updateRecentScans(data.recent_scans || []);

    // Active tasks table
    updateTasksTable(data.active_tasks || []);
  }

  function updateRecentScans(scans) {
    const container = document.getElementById("recentScans");

    if (scans.length === 0) {
      container.innerHTML =
        '<div class="text-center text-gray-500 dark:text-gray-400 py-4">No recent scans</div>';
      return;
    }

    container.innerHTML = scans
      .slice(0, 5)
      .map(
        (scan) => `
        <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700 rounded">
            <div>
                <div class="font-medium text-sm">${scan.domain}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">${formatTime(
                  scan.timestamp
                )}</div>
            </div>
            <div class="text-right">
                <div class="text-sm ${
                  scan.success ? "text-green-600" : "text-red-600"
                }">${scan.success ? "Success" : "Failed"}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">${
                  scan.duration
                }ms</div>
            </div>
        </div>
    `
      )
      .join("");
  }

  function updateTasksTable(tasks) {
    const tbody = document.getElementById("tasksTableBody");

    if (tasks.length === 0) {
      tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
                    No active tasks
                </td>
            </tr>
        `;
      return;
    }

    tbody.innerHTML = tasks
      .map(
        (task) => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                ${task.id.substring(0, 8)}...
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                ${task.type}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadgeClass(
                  task.status
                )}">
                    ${task.status}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${
                      task.progress || 0
                    }%"></div>
                </div>
                <span class="text-xs">${task.progress || 0}%</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                ${formatTime(task.started_at)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button onclick="cancelTask('${
                  task.id
                }')" class="text-red-600 hover:text-red-900">Cancel</button>
            </td>
        </tr>
    `
      )
      .join("");
  }

  function getStatusBadgeClass(status) {
    switch (status.toLowerCase()) {
      case "running":
        return "bg-blue-100 text-blue-800";
      case "completed":
        return "bg-green-100 text-green-800";
      case "failed":
        return "bg-red-100 text-red-800";
      case "pending":
        return "bg-yellow-100 text-yellow-800";
      default:
        return "bg-gray-100 text-gray-800";
    }
  }

  async function cancelTask(taskId) {
    if (!confirm("Are you sure you want to cancel this task?")) {
      return;
    }

    try {
      const response = await fetch(`/api/tasks/${taskId}/cancel`, {
        method: "POST",
      });

      if (response.ok) {
        refreshDashboard();
      } else {
        alert("Failed to cancel task");
      }
    } catch (error) {
      console.error("Error canceling task:", error);
      alert("Error canceling task");
    }
  }

  function formatBytes(bytes) {
    if (bytes === 0) return "0 Bytes";
    const k = 1024;
    const sizes = ["Bytes", "KB", "MB", "GB"];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
  }

  function formatTime(timestamp) {
    if (!timestamp) return "--";
    const date = new Date(timestamp);
    return date.toLocaleString();
  }
</script>

<!-- Font Awesome for icons -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
/>
{% endblock %}
